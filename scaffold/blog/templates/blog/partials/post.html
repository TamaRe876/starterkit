{% load static %}
{% load thumbnail %}
<div id="newPost" class="w-full">
    {% for post in posts %}
    <div class="flex flex-col bg-gray-800 rounded-lg shadow-md p-4 mb-4">
        <div class="flex items-center justify-between mb-2">
            <small class="text-gray-600">{{ post.author }}</small>
            <a href="{% url 'post-detail' post.id %}" class="text-blue-500 hover:text-blue-700">
                <h2 class="font-bold">{{ post.title }}</h2>
            </a>
        </div>

        <div class="flex items-center space-x-4">
            {% thumbnail item.image "100x100" crop="center" as im %}
    <img src="{static 'img/default.png'}" alt="Cover Art" class="w-16 h-16 object-cover rounded" width="{{ im.width }}" height="{{ im.height }}">
    {% endthumbnail %}
            <img src="{{post.cover_art.url }}" alt="Cover Art" class="w-16 h-16 object-cover rounded">
            <div id="waveform-{{ post.id }}" class="flex-grow w-96"></div>
            <button id="playBtn-{{ post.id }}" class="bg-gray-500 text-white rounded-full p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
        </div>

        <div class="flex items-center space-x-4 mt-2">
            <small class="flex items-center">
                <button class="text-red-500 mr-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                </button>
                <span>{{ post.likes_count }}</span>
            </small>
            <small class="flex items-center">
                <button class="text-blue-500 mr-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </button>
                <span>{{ post.comments_count }}</span>
            </small>
            <small class="flex items-center">
                <svg class="w-5 h-5 text-gray-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <span>{{ post.play_count }}</span>
            </small>
        </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
    const postId = '{{ post.id }}';
    const waveformContainer = document.getElementById(`waveform-${postId}`);
    const playBtn = document.getElementById(`playBtn-${postId}`);

    playBtn.disabled = true;

    const wavesurfer = WaveSurfer.create({
        container: waveformContainer,
        waveColor: 'violet',
        progressColor: 'purple',
        cursorColor: 'navy',
        barWidth: 2,
        barRadius: 3,
        cursorWidth: 1,
        height: 50,
        barGap: 3,
        backend: 'WebAudio',
        responsive: true,
        partialRender: true
    });

    try {
        // First, load a small portion of the audio to generate the waveform
        const response = await fetch('{{ post.vibe.url }}', { headers: { 'Range': 'bytes=0-100000' } });
        const arrayBuffer = await response.arrayBuffer();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // Load the partial buffer to display the waveform
        wavesurfer.loadDecodedBuffer(audioBuffer);

        // Now, load the full audio in the background
        const fullResponse = await fetch('{{ post.vibe.url }}');
        const fullArrayBuffer = await fullResponse.arrayBuffer();
        const fullAudioBuffer = await audioContext.decodeAudioData(fullArrayBuffer);

        // Replace the partial buffer with the full one
        wavesurfer.loadDecodedBuffer(fullAudioBuffer);

        playBtn.disabled = false;
    } catch (error) {
        console.error('Error loading audio:', error);
        waveformContainer.innerHTML = 'Audio preview unavailable';
        return;
    }

    playBtn.addEventListener('click', function() {
        wavesurfer.playPause();
        this.innerHTML = wavesurfer.isPlaying() ? 
            '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : 
            '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    });
});

  </script>

    {% endfor %}
</div>
